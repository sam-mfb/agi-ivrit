name: Build Release

on:
  workflow_dispatch:
    inputs:
      translation:
        description: 'Translation subdirectory (e.g., sq1, sq2, mh1)'
        required: true
        type: string
      release_tag:
        description: 'Release tag (e.g., v1)'
        required: true
        type: string
      repo:
        description: 'Target repository (e.g., sam-mfb/agi-ivrit-sq1)'
        required: true
        type: string
      patcher_name:
        description: 'Patcher name (e.g., sq1-heb)'
        required: true
        type: string

env:
  GRAFT_VERSION: "0.6.1"
  GRAFT_SHA256: "8a351d7e43a4f937727e32c7ae58c528b2312d6168ad749d3cdea8280c3c8fed"

jobs:
  build:
    runs-on: macos-latest
    timeout-minutes: 45
    environment: release  # Requires manual approval before accessing secrets

    steps:
      - name: Parse repository info
        id: repo-info
        run: |
          FULL_REPO="${{ inputs.repo }}"
          OWNER="${FULL_REPO%%/*}"
          REPO_NAME="${FULL_REPO##*/}"
          echo "owner=$OWNER" >> $GITHUB_OUTPUT
          echo "name=$REPO_NAME" >> $GITHUB_OUTPUT

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547  # v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ steps.repo-info.outputs.owner }}
          repositories: ${{ steps.repo-info.outputs.name }}

      - name: Download patches.zip from draft release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh release download "${{ inputs.release_tag }}" \
            --repo "${{ inputs.repo }}" \
            --pattern "patches.zip"
          unzip patches.zip
          ls -la patches/

      - name: Download and verify graft binary
        run: |
          curl -L -o graft "https://github.com/sam-mfb/graft/releases/download/v${GRAFT_VERSION}/graft-macos-arm64"
          echo "${GRAFT_SHA256}  graft" | shasum -a 256 --check
          chmod +x graft
          ./graft --version

      - name: Build patchers for all platforms
        run: |
          mkdir -p patchers

          for target in linux-x64 linux-arm64 windows-x64 macos-x64 macos-arm64; do
            echo "Building patcher for $target..."
            ./graft build patches --target "$target" -o patchers
          done

          echo "Built patchers:"
          ls -la patchers/

      - name: Import code signing certificate
        uses: apple-actions/import-codesign-certs@63fff01cd422d4b7b855d40ca1e9d34d2de9427d  # v3
        with:
          p12-file-base64: ${{ secrets.MACOS_CERTIFICATE }}
          p12-password: ${{ secrets.MACOS_CERTIFICATE_PWD }}

      - name: Sign macOS .app bundles
        run: |
          cd patchers

          for app in *.app; do
            if [ -d "$app" ]; then
              echo "Signing $app..."

              # Sign inner binary first (inside-out signing)
              BINARY_PATH="$app/Contents/MacOS/graft-gui"
              if [ -f "$BINARY_PATH" ]; then
                codesign --force --options runtime \
                  --sign "Developer ID Application: Samuel Davidoff (F775PQPJJC)" \
                  --timestamp \
                  "$BINARY_PATH"
                echo "  ✓ Signed inner binary"
              fi

              # Then sign outer bundle
              codesign --force --options runtime \
                --sign "Developer ID Application: Samuel Davidoff (F775PQPJJC)" \
                --timestamp \
                "$app"
              echo "  ✓ Signed bundle"

              # Verify signature
              codesign --verify --verbose=2 "$app"
              echo "  ✓ Signature verified"
            fi
          done

      - name: Prepare patchers for upload
        run: |
          cd patchers

          # Zip .app directories for macOS patchers
          for app in *.app; do
            if [ -d "$app" ]; then
              echo "Zipping $app..."
              zip -r "${app}.zip" "$app"
              rm -rf "$app"
            fi
          done

          echo "Final patchers:"
          ls -la

      - name: Upload patchers to release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          for file in patchers/*; do
            echo "Uploading $file..."
            gh release upload "${{ inputs.release_tag }}" \
              --repo "${{ inputs.repo }}" \
              "$file"
          done

      - name: Notarize macOS apps
        env:
          NOTARY_KEY: ${{ secrets.NOTARY_KEY }}
          NOTARY_KEY_ID: ${{ secrets.NOTARY_KEY_ID }}
          NOTARY_ISSUER: ${{ secrets.NOTARY_ISSUER }}
        run: |
          echo "$NOTARY_KEY" > "$RUNNER_TEMP/notary-key.p8"

          for zipfile in patchers/*.app.zip; do
            echo "Submitting $zipfile for notarization..."
            xcrun notarytool submit "$zipfile" \
              --key "$RUNNER_TEMP/notary-key.p8" \
              --key-id "$NOTARY_KEY_ID" \
              --issuer "$NOTARY_ISSUER" \
              --wait \
              --timeout 30m
          done

          rm -f "$RUNNER_TEMP/notary-key.p8"

      - name: Staple notarization tickets
        run: |
          cd patchers

          for zipfile in *.app.zip; do
            app="${zipfile%.zip}"
            echo "Stapling $app..."

            # Unzip the signed app
            unzip -q "$zipfile"

            # Staple the notarization ticket
            xcrun stapler staple "$app"

            # Re-zip with ditto to preserve macOS metadata
            rm "$zipfile"
            ditto -c -k --keepParent "$app" "$zipfile"
            rm -rf "$app"

            echo "  Stapled and re-zipped $zipfile"
          done

      - name: Re-upload stapled macOS apps
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          for zipfile in patchers/*.app.zip; do
            filename=$(basename "$zipfile")
            echo "Replacing $filename with stapled version..."

            # Delete the signed-only version
            gh release delete-asset "${{ inputs.release_tag }}" \
              --repo "${{ inputs.repo }}" \
              --yes \
              "$filename"

            # Upload the stapled version
            gh release upload "${{ inputs.release_tag }}" \
              --repo "${{ inputs.repo }}" \
              "$zipfile"
          done

      - name: Delete patches.zip from release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh release delete-asset "${{ inputs.release_tag }}" \
            --repo "${{ inputs.repo }}" \
            --yes \
            patches.zip

      - name: Publish release
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh release edit "${{ inputs.release_tag }}" \
            --repo "${{ inputs.repo }}" \
            --draft=false
